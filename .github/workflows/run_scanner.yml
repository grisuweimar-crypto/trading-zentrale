name: Scanner_vNext Autopilot

on:
  schedule:
    - cron: '0 16 * * *' # tÃ¤glich 16:00 UTC (17/18 Uhr Berlin je nach DST)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Code auschecken
        uses: actions/checkout@v4

      - name: Python installieren
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Pakete installieren
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e .

      - name: Scanner ausfÃ¼hren (run_daily)
        env:
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
          TELEGRAM_ENABLED: '0'
          # Ensure Yahoo market data refresh happens on every scheduled run.
          SCANNER_FETCH_YAHOO: '1'
        run: |
          python -m scanner.app.run_daily

      - name: Fix UI contract cols
        run: |
          python scripts/fix_contract_cols_post.py

      - name: Quality Gates (watchlist contract)
        run: |
          python scripts/validate_contract.py --csv artifacts/watchlist/watchlist_ALL.csv
          python scripts/validate_contract.py --csv artifacts/watchlist/watchlist_CORE.csv

      - name: Briefing erzeugen (deterministic)
        env:
          TELEGRAM_ENABLED: '0'
        run: |
          python scripts/generate_briefing.py

      - name: UI generieren
        env:
          TELEGRAM_ENABLED: '0'
        run: |
          python -m scanner.ui.generator

      - name: Ergebnisse speichern (Commit & Push)
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Bot"
          git add artifacts/ || true
          git commit -m "ðŸ“Š Autopilot: artifacts update [skip ci]" || echo "Keine Ã„nderungen zum Speichern"
          git push
